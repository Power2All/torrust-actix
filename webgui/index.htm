<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Torrust-Axum Admin Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Power2All">
    <meta property="og:title" content="Torrust-Axum Admin Panel">
    <meta property="og:type" content="website">
    <meta property="og:url" content="http://localhost:8080/">
    <meta property="og:description" content="The Torrust-Axum WebGUI Admin Interface">
    <meta property="og:image" content="/webgui/img/logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="180x180" href="/webgui/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/webgui/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/webgui/img/favicon-16x16.png">
    <link rel="shortcut icon" href="/webgui/img/favicon.ico">
    <link rel="icon" href="/webgui/img/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="/webgui/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,900|Roboto+Slab:400,700" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <link id="datatables" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css" rel="stylesheet" />

    <style>
        table.dataTable tbody td {
            vertical-align: middle;
        }
    </style>
</head>

<body>
<nav class="container navbar navbar-expand-lg bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Torrust-Axum</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li id="nav_li_dashboard" class="nav-item">
                    <a id="nav_button_dashboard" class="nav-link" href="#">Dashboard</a>
                </li>
                <li id="nav_li_torrents" class="nav-item">
                    <a id="nav_button_torrents" class="nav-link" href="#">Torrents</a>
                </li>
                <li id="nav_li_whitelist" class="nav-item">
                    <a id="nav_button_whitelist" class="nav-link" href="#">Whitelist</a>
                </li>
                <li id="nav_li_blacklist" class="nav-item">
                    <a id="nav_button_blacklist" class="nav-link" href="#">Blacklist</a>
                </li>
            </ul>
            <div class="d-flex">
                <input id="nav_input_access_token" class="form-control me-2" type="password" placeholder="Access Token..." aria-label="Access Token"/>
            </div>
        </div>
    </div>
</nav>
<div id="content_dashboard" class="content container mt-2 d-none">
    <div class="m-1">
        <button id="content_dashboard_button_reload" type="button" class="btn btn-primary"><i class="bi bi-arrow-clockwise" style="margin-right: 5px;"></i>Reload</button>
    </div>
    <div class="row">
        <div class="col-lg-3 p-1">
            <div class="card p-2" style="min-width: 10em; max-width: 100%; background-color: darkblue; color: white;">
                <div class="container">
                    <div class="row" style="height: 60px;">
                        <div class="col-2">
                            <i class="bi bi-layers mx-2" style="font-size: 40px;"></i>
                        </div>
                        <div class="col-10">
                            <div id="content_dashboard_torrents_count" style="margin-top: 12px; margin-left: 16px; width: calc(100% - 16px); text-align: right; font-size: 24px;"><i class="bi bi-question"></i></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 p-1">
            <div class="card p-2" style="min-width: 10em; max-width: 100%; background-color: darkblue; color: white;">
                <div class="container">
                    <div class="row" style="height: 60px;">
                        <div class="col-2">
                            <i class="bi bi-check2-circle" style="font-size: 40px;"></i>
                        </div>
                        <div class="col-10">
                            <div id="content_dashboard_completed_count" style="margin-top: 12px; margin-left: 16px; width: calc(100% - 16px); text-align: right; font-size: 24px;"><i class="bi bi-question"></i></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 p-1">
            <div class="card p-2" style="min-width: 10em; max-width: 100%; background-color: darkgreen; color: white;">
                <div class="container">
                    <div class="row" style="height: 60px;">
                        <div class="col-2">
                            <i class="bi bi-upload mx-2" style="font-size: 40px;"></i>
                        </div>
                        <div class="col-10">
                            <div id="content_dashboard_seeders_count" style="margin-top: 12px; margin-left: 16px; width: calc(100% - 16px); text-align: right; font-size: 24px;"><i class="bi bi-question"></i></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 p-1">
            <div class="card p-2" style="min-width: 10em; max-width: 100%; background-color: darkred; color: white;">
                <div class="container">
                    <div class="row" style="height: 60px;">
                        <div class="col-2">
                            <i class="bi bi-download mx-2" style="font-size: 40px;"></i>
                        </div>
                        <div class="col-10">
                            <div id="content_dashboard_leechers_count" style="margin-top: 12px; margin-left: 16px; width: calc(100% - 16px); text-align: right; font-size: 24px;"><i class="bi bi-question"></i></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="content_torrents" class="content container mt-2 d-none">
    <div class="m-1">
        <button id="content_torrents_button_load" type="button" class="btn btn-primary"><i class="bi bi-download" style="margin-right: 5px;"></i>Load Torrents</button>
        <button id="content_torrents_button_clear" type="button" class="btn btn-primary"><i class="bi bi-eraser" style="margin-right: 5px;"></i>Clear Table</button>
    </div>
    <table id="torrents_table" class="table table-striped" style="width:100%">
        <thead>
        <tr>
            <th>Hash (HEX)</th>
            <th><div style="width: 120px; font-size: 18px;" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Amount of Seeders"><strong><i class="bi bi-cloud-arrow-up"></i></strong></div></th>
            <th><div style="width: 120px; font-size: 18px;" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Amount of Leechers"><strong><i class="bi bi-cloud-arrow-down"></i></strong></div></th>
            <th><div style="width: 120px; font-size: 18px;" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Amount of Downloads"><strong><i class="bi bi-check2-circle"></i></strong></div></th>
            <th></th>
        </tr>
        </thead>
    </table>
</div>
<div class="modal fade" id="whitelist_remove_backdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="whitelist_remove_backdrop" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Remove Whitelist Hash</h5>
            </div>
            <div class="modal-body">
                Are you sure you want to remove this hash from the whitelist?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-circle me-2"></i>No</button>
                <button id="whitelist_remove_button" torrent_id="" type="button" class="btn btn-primary"><i class="bi bi-check-circle me-2"></i>Yes</button>
            </div>
        </div>
    </div>
</div>

<div id="content_whitelist" class="content container mt-2 d-none">
    <div class="m-1">
        <button id="content_whitelist_button_load" type="button" class="btn btn-primary"><i class="bi bi-download" style="margin-right: 5px;"></i>Load Whitelist</button>
        <button id="content_whitelist_button_clear" type="button" class="btn btn-primary"><i class="bi bi-eraser" style="margin-right: 5px;"></i>Clear Table</button>
        <button id="content_whitelist_button_add" type="button" class="btn btn-primary"><i class="bi bi-plus-circle" style="margin-right: 5px;"></i>Add to Whitelist</button>
    </div>
    <table id="whitelist_table" class="table table-striped" style="width:100%">
        <thead>
        <tr>
            <th>Hash (HEX)</th>
            <th></th>
        </tr>
        </thead>
    </table>
</div>
<div class="modal fade" id="torrents_remove_backdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="torrents_remove_backdrop" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">Remove Torrent</h5>
            </div>
            <div class="modal-body">
                Are you sure you want to remove this torrent?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-circle me-2"></i>No</button>
                <button id="torrents_remove_button" torrent_id="" type="button" class="btn btn-primary"><i class="bi bi-check-circle me-2"></i>Yes</button>
            </div>
        </div>
    </div>
</div>


<div id="content_blacklist" class="content container mt-2 d-none">
    Blacklist
</div>

<div id="message" class="toast align-items-center text-bg-primary border-0 position-fixed bottom-0 end-0 p-3" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
        <div class="toast-body"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js" integrity="sha384-Xe+8cL9oJa6tN/veChSP7q+mnSPaj5Bcu9mPX5F5xIGE0DVittaqT5lorf0EI7Vk" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.min.js" integrity="sha384-ODmDIVzN+pFdexxHEHFBQH3/9/vQ9uori45z4JjnFsRydbmQbmL5t1tQ0culUzyK" crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js" integrity="sha512-odNmoc1XJy5x1TMVMdC7EMs3IVdItLPlCeL5vSUPN2llYKMJ2eByTTAIiiuqLg+GdNr9hF6z81p27DArRFKT7A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    let current_table_element = null;
    let torrents_table_element = null;
    let torrents_table = null;
    $(document).ready(function() {
        console.log("Webpage Loaded");

        // Init data tables
        torrents_table_element = $("#torrents_table");
        torrents_table = torrents_table_element.DataTable({
            autoWidth: false,
            pageLength: 100,
            columns: [
                { width: '100%', verticalAlign: 'middle', targets: 0 },
                { width: '120px', targets: 1 },
                { width: '120px', targets: 2 },
                { width: '120px', targets: 3 },
                { width: '32px', targets: 4 },
            ]
        });

        torrents_table.columns.adjust();
        let whitelist_table = $("#whitelist_table").DataTable({
            autoWidth: false,
            columns: [
                { width: '100%', verticalAlign: 'middle', targets: 0 },
                { width: '32px', targets: 1 },
            ]
        });

        // Enable tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

        // Initial Work
        $("#nav_li_dashboard").addClass("active");
        $("#content_dashboard").removeClass("d-none");

        $("#nav_button_dashboard").on("click", function(event) {
            event.preventDefault();
            $(".content").each(function() {
                $(this).addClass("d-none");
            });
            $("#content_dashboard").removeClass("d-none");
        });

        $("#nav_button_torrents").on("click", function(event) {
            event.preventDefault();
            $(".content").each(function() {
                $(this).addClass("d-none");
            });
            $("#content_torrents").removeClass("d-none");
        });

        $("#nav_button_whitelist").on("click", function(event) {
            event.preventDefault();
            $(".content").each(function() {
                $(this).addClass("d-none");
            });
            $("#content_whitelist").removeClass("d-none");
        });

        $("#nav_button_blacklist").on("click", function(event) {
            event.preventDefault();
            $(".content").each(function() {
                $(this).addClass("d-none");
            });
            $("#content_blacklist").removeClass("d-none");
        });

        // Buttons on Dashboard page
        $("#content_dashboard_button_reload").on("click", function(event) {
            event.preventDefault();
            $("#content_dashboard_button_reload").prop('disabled', true);
            loadStats();
        });
        // Buttons on Torrents page
        $("#content_torrents_button_load").on("click", function(event) {
            event.preventDefault();
            $("#content_torrents_button_load").prop('disabled', true);
            loadTorrents(torrents_table, torrents_table_element);
        });

        $("#content_torrents_button_clear").on("click", function(event) {
            event.preventDefault();
            let content_torrents_button_clear = $("#content_torrents_button_clear");
            content_torrents_button_clear.prop('disabled', true);
            torrents_table.clear().draw(false);
            content_torrents_button_clear.prop('disabled', false);
        });

        $("#torrents_remove_button").on("click", function(event) {
            event.preventDefault();
            executeRemoveTorrent($("#torrents_remove_button").attr("torrent_id"));
            $("#torrents_remove_backdrop").modal('hide');
        });

        // Buttons on Whitelist page
        $("#content_whitelist_button_load").on("click", function(event) {
            event.preventDefault();
            $("#content_whitelist_button_load").prop('disabled', true);
            loadWhitelist(whitelist_table);
        });

        $("#content_whitelist_button_clear").on("click", function(event) {
            event.preventDefault();
            let content_whitelist_button_clear = $("#content_whitelist_button_clear");
            content_whitelist_button_clear.prop('disabled', true);
            whitelist_table.clear().draw(false);
            content_whitelist_button_clear.prop('disabled', false);
        });
    });

    async function loadStats() {
        let access_token = $("#nav_input_access_token").val();

        let content_dashboard_button_reload = $("#content_dashboard_button_reload");
        let content_dashboard_torrents_count = $("#content_dashboard_torrents_count");
        let content_dashboard_completed_count = $("#content_dashboard_completed_count");
        let content_dashboard_seeders_count = $("#content_dashboard_seeders_count");
        let content_dashboard_leechers_count = $("#content_dashboard_leechers_count");

        content_dashboard_torrents_count.html("<div class=\"spinner-grow\" role=\"status\"></div>");
        content_dashboard_completed_count.html("<div class=\"spinner-grow\" role=\"status\"></div>");
        content_dashboard_seeders_count.html("<div class=\"spinner-grow\" role=\"status\"></div>");
        content_dashboard_leechers_count.html("<div class=\"spinner-grow\" role=\"status\"></div>");

        axios.get('/api/stats?token=' + encodeURIComponent(access_token))
            .then(function (response) {
                if (response.data.status !== undefined && response.data.status !== "ok") {
                    notificationOnScreen("Unable to load statistics: " + response.data.status);
                    content_dashboard_button_reload.prop('disabled', false);
                    content_dashboard_torrents_count.html("<i class=\"bi bi-question\"></i>");
                    content_dashboard_completed_count.html("<i class=\"bi bi-question\"></i>");
                    content_dashboard_seeders_count.html("<i class=\"bi bi-question\"></i>");
                    content_dashboard_leechers_count.html("<i class=\"bi bi-question\"></i>");
                    return;
                }
                content_dashboard_button_reload.prop('disabled', false);
                content_dashboard_torrents_count.html(response.data.torrents);
                content_dashboard_completed_count.html(response.data.completed);
                content_dashboard_seeders_count.html(response.data.seeds);
                content_dashboard_leechers_count.html(response.data.peers);
            })
            .catch(function (error) {
                let message = $("#message");
                message.find(".toast-body").html("Unable to load torrents: " + error.message);
                let toast = new bootstrap.Toast(message);
                toast.show();
                content_dashboard_button_reload.prop('disabled', false);
                content_dashboard_torrents_count.html("<i class=\"bi bi-question\"></i>");
                content_dashboard_completed_count.html("<i class=\"bi bi-question\"></i>");
                content_dashboard_seeders_count.html("<i class=\"bi bi-question\"></i>");
                content_dashboard_leechers_count.html("<i class=\"bi bi-question\"></i>");
            });
    }

    async function loadTorrents(table_datatable, table_element) {
        let access_token = $("#nav_input_access_token").val();
        let content_torrents_button_load = $("#content_torrents_button_load");

        axios.get('/api/torrents?token=' + encodeURIComponent(access_token))
            .then(function (response) {
                if (response.data.status !== undefined && response.data.status !== "ok") {
                    notificationOnScreen("Unable to load torrents: " + response.data.status);
                    content_torrents_button_load.prop('disabled', false);
                    return;
                }

                table_datatable.clear().draw(false);
                for (let value of response.data) {
                    table_datatable.row.add([
                        value.info_hash,
                        value.seeders,
                        value.leechers,
                        value.completed,
                        "<button class=\"btn btn-primary btn-sm torrent_remove_button\" torrent_id=\"" + value.info_hash + "\" style=\"padding-top: 2px; padding-bottom: 2px;\" data-bs-toggle=\"tooltip\" data-bs-placement=\"top\" data-bs-title=\"Remove this torrent hash from tracker\"><i class=\"bi bi-trash\"></i></button>"
                    ]);
                }
                table_datatable.draw(false);
                const tooltipTriggerList = table_element.find('[data-bs-toggle="tooltip"]');
                const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
                initButtonsTorrents();

                content_torrents_button_load.prop('disabled', false);
            })
            .catch(function (error) {
                notificationOnScreen("Unable to load torrents: " + error.message);
                content_torrents_button_load.prop('disabled', false);
            });
    }

    async function loadWhitelist(table_element) {
        let access_token = $("#nav_input_access_token").val();
        let content_whitelist_button_load = $("#content_whitelist_button_load");

        axios.get('/api/whitelist?token=' + encodeURIComponent(access_token))
            .then(function (response) {
                if (response.data.status !== undefined && response.data.status !== "ok") {
                    notificationOnScreen("Unable to load whitelist: " + response.data.status);
                    content_whitelist_button_load.prop('disabled', false);
                    return;
                }

                table_element.clear().draw(false);
                for (let value of response.data) {
                    table_element.row.add([
                        value,
                        "<button class=\"btn btn-primary btn-sm\" style=\"padding-top: 2px; padding-bottom: 2px;\"><i class=\"bi bi-trash\"></i></button>"
                    ]);
                    console.log(value);
                }
                table_element.draw(false);

                content_whitelist_button_load.prop('disabled', false);
            })
            .catch(function (error) {
                notificationOnScreen("Unable to load whitelist: " + error.message);
                content_whitelist_button_load.prop('disabled', false);
            });
    }

    async function initButtonsTorrents() {
        $(".torrent_remove_button").on("click", function(event) {
            event.preventDefault();
            current_table_element = $(this).parents('tr');
            $("#torrents_remove_button").attr("torrent_id", $(this).attr("torrent_id"));
            $("#torrents_remove_backdrop").modal('show');
        });
    }

    async function executeRemoveTorrent(id) {
        let access_token = $("#nav_input_access_token").val();

        axios.delete('/api/torrent/' + encodeURIComponent(id) + '?token=' + encodeURIComponent(access_token), { data: {} })
            .then(function (response) {
                if (response.data.status !== undefined && response.data.status === 'ok') {
                    torrents_table.row(current_table_element).remove().draw();
                    notificationOnScreen("Torrent ID " + id + " removed");
                    return;
                }
                if (response.data.status !== undefined && response.data.status !== 'ok') {
                    notificationOnScreen("Error while removing torrent ID " + id + ": " + response.data.status);
                    return;
                }
                notificationOnScreen("Unknown return data while removing torrent ID " + id);
            })
            .catch(function () {
                notificationOnScreen("Unable to remove torrent ID " + id);
            });
    }

    async function notificationOnScreen(msg) {
        let message = $("#message");
        message.find(".toast-body").html(msg);
        let toast = new bootstrap.Toast(message);
        toast.show();
    }
</script>
</body>