FROM rust:alpine3.18

ARG FULL_CONFIG=""
ENV FULL_CONFIG=$FULL_CONFIG

ARG LOG_LEVEL="info"
ARG LOG_CONSOLE_INTERVAL=10
ARG STATISTICS_ENABLED="true"
ENV LOG_LEVEL=$LOG_LEVEL LOG_CONSOLE_INTERVAL=$LOG_CONSOLE_INTERVAL STATISTICS_ENABLED=$STATISTICS_ENABLED

ARG DB_DRIVER="SQLite3"
ARG DB_PATH="sqlite://:memory:"
ENV DB_DRIVER=$DB_DRIVER DB_PATH=$DB_PATH

ARG PERSISTENCE="false"
ARG PERSISTENCE_INTERVAL=300
ENV PERSISTENCE=$PERSISTENCE PERSISTENCE_INTERVAL=$PERSISTENCE_INTERVAL

ARG API_KEY="MyAccessToken"
ENV API_KEY=$API_KEY

ARG WHITELIST="false"
ARG BLACKLIST="false"
ENV WHITELIST=$WHITELIST BLACKLIST=$BLACKLIST

ARG KEYS="false"
ARG KEYS_CLEANUP_INTERVAL=60
ENV KEYS=$KEYS KEYS_CLEANUP_INTERVAL=$KEYS_CLEANUP_INTERVAL

ARG INTERVAL=1800
ARG INTERVAL_MINIMUM=1800
ENV INTERVAL=$INTERVAL INTERVAL_MINIMUM=$INTERVAL_MINIMUM

ARG INTERVAL_CLEANUP=900
ARG PEER_TIMEOUT=2400
ENV INTERVAL_CLEANUP=$INTERVAL_CLEANUP PEER_TIMEOUT=$PEER_TIMEOUT

ARG PEERS_RETURNED=200
ENV PEERS_RETURNED=$PEERS_RETURNED

ARG UDPV4_SERVER_ENABLED="true"
ARG UDPV4_SERVER_BIND_ADDRESS="0.0.0.0:6969"
ENV UDPV4_SERVER_ENABLED=$UDPV4_SERVER_ENABLED UDPV4_SERVER_BIND_ADDRESS=$UDPV4_SERVER_BIND_ADDRESS

ARG UDPV6_SERVER_ENABLED="false"
ARG UDPV6_SERVER_BIND_ADDRESS="[::]:6969"
ENV UDPV6_SERVER_ENABLED=$UDPV6_SERVER_ENABLED UDPV6_SERVER_BIND_ADDRESS=$UDPV6_SERVER_BIND_ADDRESS

ARG TCPV4_SERVER_ENABLED="true"
ARG TCPV4_SERVER_BIND_ADDRESS="0.0.0.0:6969"
ARG TCPV4_SERVER_SSL="false"
ARG TCPV4_SERVER_SSL_KEY=""
ARG TCPV4_SERVER_SSL_CERT=""
ENV TCPV4_SERVER_ENABLED=$TCPV4_SERVER_ENABLED TCPV4_SERVER_BIND_ADDRESS=$TCPV4_SERVER_BIND_ADDRESS TCPV4_SERVER_SSL=$TCPV4_SERVER_SSL TCPV4_SERVER_SSL_KEY=$TCPV4_SERVER_SSL_KEY TCPV4_SERVER_SSL_CERT=$TCPV4_SERVER_SSL_CERT

ARG TCPV6_SERVER_ENABLED="false"
ARG TCPV6_SERVER_BIND_ADDRESS="[::]:6969"
ARG TCPV6_SERVER_SSL="false"
ARG TCPV6_SERVER_SSL_KEY=""
ARG TCPV6_SERVER_SSL_CERT=""
ENV TCPV6_SERVER_ENABLED=$TCPV6_SERVER_ENABLED TCPV6_SERVER_BIND_ADDRESS=$TCPV6_SERVER_BIND_ADDRESS TCPV6_SERVER_SSL=$TCPV6_SERVER_SSL TCPV6_SERVER_SSL_KEY=$TCPV6_SERVER_SSL_KEY TCPV6_SERVER_SSL_CERT=$TCPV6_SERVER_SSL_CERT

ARG TCPV4_API_ENABLED="true"
ARG TCPV4_API_BIND_ADDRESS="0.0.0.0:8080"
ARG TCPV4_API_SSL="false"
ARG TCPV4_API_SSL_KEY=""
ARG TCPV4_API_SSL_CERT=""
ENV TCPV4_API_ENABLED=$TCPV4_API_ENABLED TCPV4_API_BIND_ADDRESS=$TCPV4_API_BIND_ADDRESS TCPV4_API_SSL=$TCPV4_API_SSL TCPV4_API_SSL_KEY=$TCPV4_API_SSL_KEY TCPV4_API_SSL_CERT=$TCPV4_API_SSL_CERT

ARG TCPV6_API_ENABLED="false"
ARG TCPV6_API_BIND_ADDRESS="[::]:8080"
ARG TCPV6_API_SSL="false"
ARG TCPV6_API_SSL_KEY=""
ARG TCPV6_API_SSL_CERT=""
ENV TCPV6_API_ENABLED=$TCPV6_API_ENABLED TCPV6_API_BIND_ADDRESS=$TCPV6_API_BIND_ADDRESS TCPV6_API_SSL=$TCPV6_API_SSL TCPV6_API_SSL_KEY=$TCPV6_API_SSL_KEY TCPV6_API_SSL_CERT=$TCPV6_API_SSL_CERT

ARG DB_STRUCTURE_DB_TORRENTS="torrents"
ARG DB_STRUCTURE_TABLE_TORRENTS_INFO_HASH="info_hash"
ARG DB_STRUCTURE_TABLE_TORRENTS_COMPLETED="completed"
ENV DB_STRUCTURE_DB_TORRENTS=$DB_STRUCTURE_DB_TORRENTS DB_STRUCTURE_TABLE_TORRENTS_INFO_HASH=$DB_STRUCTURE_TABLE_TORRENTS_INFO_HASH DB_STRUCTURE_TABLE_TORRENTS_COMPLETED=$DB_STRUCTURE_TABLE_TORRENTS_COMPLETED

ARG DB_STRUCTURE_DB_WHITELIST="whitelist"
ARG DB_STRUCTURE_TABLE_WHITELIST_INFO_HASH="info_hash"
ENV DB_STRUCTURE_DB_WHITELIST=$DB_STRUCTURE_DB_WHITELIST DB_STRUCTURE_TABLE_WHITELIST_INFO_HASH=$DB_STRUCTURE_TABLE_WHITELIST_INFO_HASH

ARG DB_STRUCTURE_DB_BLACKLIST="blacklist"
ARG DB_STRUCTURE_TABLE_BLACKLIST_INFO_HASH="info_hash"
ENV DB_STRUCTURE_DB_BLACKLIST=$DB_STRUCTURE_DB_BLACKLIST DB_STRUCTURE_TABLE_BLACKLIST_INFO_HASH=$DB_STRUCTURE_TABLE_BLACKLIST_INFO_HASH

ARG DB_STRUCTURE_DB_KEYS="keys"
ARG DB_STRUCTURE_TABLE_KEYS_HASH="hash"
ARG DB_STRUCTURE_TABLE_KEYS_TIMEOUT="timeout"
ENV DB_STRUCTURE_DB_KEYS=$DB_STRUCTURE_DB_KEYS DB_STRUCTURE_TABLE_KEYS_HASH=$DB_STRUCTURE_TABLE_KEYS_HASH DB_STRUCTURE_TABLE_KEYS_TIMEOUT=$DB_STRUCTURE_TABLE_KEYS_TIMEOUT

ARG USERS="false"
ENV USERS=$USERS

ARG DB_STRUCTURE_DB_USERS="users"
ARG DB_STRUCTURE_TABLE_USERS_UUID="uuid"
ARG DB_STRUCTURE_TABLE_USERS_KEY="keyhash"
ARG DB_STRUCTURE_TABLE_USERS_UPLOADED="uploaded"
ARG DB_STRUCTURE_TABLE_USERS_DOWNLOADED="downloaded"
ARG DB_STRUCTURE_TABLE_USERS_COMPLETED="completed"
ARG DB_STRUCTURE_TABLE_USERS_UPDATED="updated"
ARG DB_STRUCTURE_TABLE_USERS_ACTIVE="active"
ENV DB_STRUCTURE_DB_USERS=$DB_STRUCTURE_DB_USERS DB_STRUCTURE_TABLE_USERS_UUID=$DB_STRUCTURE_TABLE_USERS_UUID DB_STRUCTURE_TABLE_USERS_KEY=$DB_STRUCTURE_TABLE_USERS_KEY DB_STRUCTURE_TABLE_USERS_UPLOADED=$DB_STRUCTURE_TABLE_USERS_UPLOADED DB_STRUCTURE_TABLE_USERS_DOWNLOADED=$DB_STRUCTURE_TABLE_USERS_DOWNLOADED DB_STRUCTURE_TABLE_USERS_COMPLETED=$DB_STRUCTURE_TABLE_USERS_COMPLETED DB_STRUCTURE_TABLE_USERS_UPDATED=$DB_STRUCTURE_TABLE_USERS_UPDATED DB_STRUCTURE_TABLE_USERS_ACTIVE=$DB_STRUCTURE_TABLE_USERS_ACTIVE

RUN apk add git musl-dev
RUN git clone https://github.com/Power2All/torrust-actix.git /root/torrust-actix
RUN cd /root/torrust-actix && git checkout tags/v3.2.1
WORKDIR /root/torrust-actix
RUN cd /root/torrust-actix
RUN cargo build --release && rm -Rf target/release/.fingerprint target/release/build target/release/deps target/release/examples target/release/incremental
COPY init.sh /root/torrust-actix/target/release/init.sh
RUN chmod +x /root/torrust-actix/target/release/init.sh
EXPOSE 8080/tcp
EXPOSE 6969/tcp
EXPOSE 6969/udp
CMD cd /root/torrust-actix/target/release/ && ./init.sh && ./torrust-actix
